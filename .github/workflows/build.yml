name: Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        
    - name: Validate PHP syntax
      run: |
        find . -name "*.php" -type f -exec php -l {} \; 2>&1 | grep -v "No syntax errors" && exit 1 || exit 0
        
    - name: Prepare build artifacts
      run: |
        mkdir -p build
        cp -r app build/
        cp -r public build/
        cp -r views build/
        cp README.md LICENSE build/ 2>/dev/null || true
        cp .htaccess build/ 2>/dev/null || true
        ls -la build/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: droiddb-build
        path: build/
        
  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: droiddb-build
        path: build/
        
    - name: Create release package
      run: |
        zip -r droiddb-latest.zip build/
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: droiddb-latest.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
